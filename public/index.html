<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuoraClone - Tanya Jawab</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <h1 class="logo">QuoraClone</h1>
            </div>
            <div class="nav-right" id="navRight">
                <!-- Nav akan diubah berdasarkan status login -->
            </div>
        </div>
    </nav>

    <div class="main-container" style="grid-template-columns: 1fr; max-width: 800px;">
        <!-- Content utama -->
        <main class="main-content">
            <!-- Form Buat Pertanyaan (hanya untuk user login) -->
            <div class="question-box" id="questionBox" style="display: none;">
                <div class="question-header">
                    <div class="user-avatar small" id="userAvatar">U</div>
                    <input type="text" id="postTitle" class="question-input"
                        placeholder="Apa yang ingin Anda tanyakan atau bagikan?">
                </div>
                <div class="question-body" id="questionBody" style="display: none;">
                    <textarea id="postContent" rows="4"
                        placeholder="Tulis pertanyaan atau informasi Anda dengan lebih detail..."></textarea>
                    <div class="question-actions">
                        <button class="btn-cancel" onclick="cancelPost()">Batal</button>
                        <button class="btn-post" onclick="createPost()">Posting</button>
                    </div>
                </div>
            </div>

            <!-- Timeline Posts -->
            <div id="timeline" class="timeline">
                <!-- Posts akan dimuat di sini -->
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        const API_URL = '/api';
        let currentUser = null;

        // Check login status saat halaman dimuat
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            loadPosts();
        });

        // Cek apakah user sudah login
        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/auth/me`);
                if (response.ok) {
                    currentUser = await response.json();
                    updateNavbar(true);
                    document.getElementById('questionBox').style.display = 'block';
                    document.getElementById('userAvatar').textContent = currentUser.username[0].toUpperCase();
                } else {
                    currentUser = null;
                    updateNavbar(false);
                    document.getElementById('questionBox').style.display = 'none';
                }
            } catch (error) {
                currentUser = null;
                updateNavbar(false);
            }
        }

        // Update navbar berdasarkan status login
        function updateNavbar(isLoggedIn) {
            const navRight = document.getElementById('navRight');
            if (isLoggedIn) {
                navRight.innerHTML = `
                    <span class="nav-btn" style="cursor: default;">${currentUser.username}</span>
                    <button class="nav-btn" onclick="logout()">Logout</button>
                `;
            } else {
                navRight.innerHTML = `
                    <button class="nav-btn" onclick="window.location.href='login.html'">Login</button>
                    <button class="nav-btn" onclick="window.location.href='register.html'">Daftar</button>
                `;
            }
        }

        // Logout
        async function logout() {
            try {
                await fetch(`${API_URL}/auth/logout`, {method: 'POST'});
                currentUser = null;
                updateNavbar(false);
                document.getElementById('questionBox').style.display = 'none';
                showToast('‚úÖ Logout berhasil!', 'success');
                loadPosts();
            } catch (error) {
                showToast('‚ùå Error logout', 'error');
            }
        }

        // Show question body when input clicked
        document.getElementById('postTitle').addEventListener('focus', () => {
            document.getElementById('questionBody').style.display = 'block';
        });

        function cancelPost() {
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            document.getElementById('questionBody').style.display = 'none';
        }

        async function loadPosts() {
            try {
                const response = await fetch(`${API_URL}/posts`);
                const posts = await response.json();

                const timeline = document.getElementById('timeline');
                timeline.innerHTML = '';

                if (posts.length === 0) {
                    timeline.innerHTML = '<div class="empty-state">Belum ada pertanyaan. Jadilah yang pertama bertanya!</div>';
                    return;
                }

                posts.forEach(post => {
                    timeline.appendChild(createPostElement(post));
                });
            } catch (error) {
                showToast('‚ùå Error memuat posts', 'error');
            }
        }

        function createPostElement(post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post-card';

            // Cek apakah user adalah pemilik post
            const isOwner = currentUser && post.author === currentUser.username;

            postDiv.innerHTML = `
                <div class="post-author">
                    <div class="user-avatar small">${post.author[0].toUpperCase()}</div>
                    <div class="author-info">
                        <div class="author-name">${post.author}</div>
                        <div class="post-time">${formatDate(post.timestamp)}</div>
                    </div>
                    ${isOwner ? `
                    <div class="post-menu">
                        <button class="menu-btn" onclick="showMenu(event, '${post._id}')">‚ãØ</button>
                        <div class="dropdown-menu" id="menu-${post._id}">
                            <div class="menu-item delete" onclick="deletePost('${post._id}')">üóëÔ∏è Hapus</div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="post-content">
                    <h2 class="post-title">${post.title}</h2>
                    <p class="post-text">${post.content}</p>
                </div>

                <div class="post-stats">
                    <span>${post.likes} upvotes</span>
                    <span>¬∑</span>
                    <span>${post.comments.length} jawaban</span>
                </div>

                <div class="post-actions">
                    <button class="action-btn" onclick="likePost('${post._id}')">
                        <span class="icon">‚¨Ü</span> Upvote
                    </button>
                    <button class="action-btn" onclick="toggleComments('${post._id}')">
                        <span class="icon">üí¨</span> Jawab
                    </button>
                </div>

                <div id="comments-${post._id}" class="comments-container" style="display: none;">
                    ${currentUser ? `
                    <div class="add-answer">
                        <div class="user-avatar small">${currentUser.username[0].toUpperCase()}</div>
                        <div class="answer-input-group">
                            <textarea id="commentText-${post._id}" placeholder="Tulis jawaban Anda..." rows="3"></textarea>
                            <button onclick="addComment('${post._id}')" class="btn-submit-answer">Kirim Jawaban</button>
                        </div>
                    </div>
                    ` : `
                    <div class="add-answer">
                        <p style="text-align: center; color: #939598; padding: 20px;">
                            <a href="login.html" style="color: #b92b27; text-decoration: none;">Login</a> untuk memberikan jawaban
                        </p>
                    </div>
                    `}

                    <div class="answers-list">
                        ${post.comments.map(comment => {
                const isCommentOwner = currentUser && comment.user === currentUser.username;
                return `
                            <div class="answer-card">
                                <div class="answer-header">
                                    <div class="user-avatar tiny">${comment.user[0].toUpperCase()}</div>
                                    <div class="answer-author">
                                        <div class="author-name">${comment.user}</div>
                                        <div class="answer-time">${formatDate(comment.timestamp)}</div>
                                    </div>
                                    ${isCommentOwner ? `
                                    <button class="delete-comment" onclick="deleteComment('${post._id}', '${comment._id}')">√ó</button>
                                    ` : ''}
                                </div>
                                <div class="answer-text">${comment.text}</div>
                            </div>
                            `;
            }).join('')}
                    </div>
                </div>
            `;
            return postDiv;
        }

        function showMenu(event, postId) {
            event.stopPropagation();
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (menu.id !== `menu-${postId}`) menu.classList.remove('show');
            });
            document.getElementById(`menu-${postId}`).classList.toggle('show');
        }

        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        });

        async function createPost() {
            if (!currentUser) {
                showToast('‚ö†Ô∏è Harus login terlebih dahulu!', 'warning');
                return;
            }

            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();

            if (!title || !content) {
                showToast('‚ö†Ô∏è Judul dan konten harus diisi!', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/posts`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title, content})
                });

                if (response.ok) {
                    showToast('‚úÖ Pertanyaan berhasil diposting!', 'success');
                    cancelPost();
                    loadPosts();
                } else {
                    const error = await response.json();
                    showToast('‚ùå ' + (error.message || 'Error membuat post'), 'error');
                }
            } catch (error) {
                showToast('‚ùå Error membuat post', 'error');
            }
        }

        async function deletePost(postId) {
            if (!confirm('Yakin ingin menghapus post ini?')) return;

            try {
                const response = await fetch(`${API_URL}/posts/${postId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('‚úÖ Post berhasil dihapus!', 'success');
                    loadPosts();
                } else {
                    showToast('‚ùå Gagal menghapus post', 'error');
                }
            } catch (error) {
                showToast('‚ùå Error menghapus post', 'error');
            }
        }

        async function likePost(postId) {
            try {
                const response = await fetch(`${API_URL}/likes/${postId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showToast('üëç Upvoted!', 'success');
                    loadPosts();
                }
            } catch (error) {
                showToast('‚ùå Error like post', 'error');
            }
        }

        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
        }

        async function addComment(postId) {
            if (!currentUser) {
                showToast('‚ö†Ô∏è Harus login terlebih dahulu!', 'warning');
                return;
            }

            const text = document.getElementById(`commentText-${postId}`).value.trim();

            if (!text) {
                showToast('‚ö†Ô∏è Jawaban harus diisi!', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/comments/${postId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({text})
                });

                if (response.ok) {
                    showToast('‚úÖ Jawaban berhasil ditambahkan!', 'success');
                    document.getElementById(`commentText-${postId}`).value = '';
                    loadPosts();
                } else {
                    const error = await response.json();
                    showToast('‚ùå ' + (error.message || 'Error menambahkan jawaban'), 'error');
                }
            } catch (error) {
                showToast('‚ùå Error menambahkan jawaban', 'error');
            }
        }

        async function deleteComment(postId, commentId) {
            if (!confirm('Yakin ingin menghapus jawaban ini?')) return;

            try {
                const response = await fetch(`${API_URL}/comments/${postId}/${commentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('‚úÖ Jawaban berhasil dihapus!', 'success');
                    loadPosts();
                } else {
                    showToast('‚ùå Gagal menghapus jawaban', 'error');
                }
            } catch (error) {
                showToast('‚ùå Error menghapus jawaban', 'error');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Baru saja';
            if (diff < 3600) return Math.floor(diff / 60) + ' menit yang lalu';
            if (diff < 86400) return Math.floor(diff / 3600) + ' jam yang lalu';
            if (diff < 604800) return Math.floor(diff / 86400) + ' hari yang lalu';

            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;

            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
    </script>
</body>

</html>
